const axios = require("axios");
const { default: PQueue } = require("p-queue");
require("dotenv").config();
const OpenAI = require("openai");

const OPENAI_API_KEY = process.env.OPENAI_API_KEY;

// --- Initialize OpenAI client ---
const openai = new OpenAI({
  apiKey: OPENAI_API_KEY,
});

// --- Rate Limiting Queue ---
const queue = new PQueue({
  interval: 35000, // 35 seconds between requests
  intervalCap: 1, // Only 1 request per interval
});

async function callChatGPT(question) {
  console.log("Adding request to the queue... Waiting for its turn.");
  try {
    const response = await openai.chat.completions.create({
      model: "gpt-4o-mini", // Fast + cheaper; change to gpt-4o for higher quality
      messages: [
        {
          role: "system",
          content:
            "You are an expert tutor for JEE, NEET, and 10th CBSE. Only answer questions relevant to these topics.",
        },
        {
          role: "user",
          content: question,
        },
      ],
      temperature: 0.3,
      max_tokens: 500,
    });

    console.log("API call successful.");
    return response.choices[0].message.content || "No answer found.";
  } catch (error) {
    console.error(
      "Error during ChatGPT API call:",
      error.response?.data || error.message
    );
    throw new Error("Failed to contact ChatGPT API.");
  }
}
// Controller: Handles question requests
exports.askQuestion = async (req, res) => {
  console.log(req.body);
  const { question } = req.body;

  if (!question) {
    return res.status(400).json({ error: "Question is required" });
  }

  const allowedTopics = [
    // ... (your extensive list of allowed topics remains unchanged)
    "jee",
    "neet",
    "10th",
    "cbse",
    "class 10",
    "board exam",
    "physics",
    "chemistry",
    "maths",
    "mathematics",
    "biology",
    "science",
    "units and measurements",
    "errors in measurement",
    "dimensional analysis",
    "kinematics",
    "displacement",
    "velocity",
    "acceleration",
    "projectile motion",
    "relative velocity",
    "laws of motion",
    "friction",
    "circular motion",
    "work power energy",
    "potential energy",
    "kinetic energy",
    "law of conservation of energy",
    "center of mass",
    "moment of inertia",
    "parallel axis theorem",
    "perpendicular axis theorem",
    "rotational motion",
    "torque",
    "angular momentum",
    "rolling motion",
    "gravitation",
    "acceleration due to gravity",
    "satellite motion",
    "escape velocity",
    "oscillations",
    "simple harmonic motion",
    "damped oscillations",
    "forced oscillations",
    "resonance",
    "thermodynamics",
    "zeroth law",
    "first law of thermodynamics",
    "second law of thermodynamics",
    "heat engines",
    "refrigerators",
    "thermal properties of matter",
    "heat transfer",
    "conduction",
    "convection",
    "radiation",
    "kinetic theory of gases",
    "ideal gas equation",
    "mean free path",
    "waves",
    "types of waves",
    "sound waves",
    "speed of sound",
    "doppler effect",
    "wave optics",
    "interference",
    "young double slit experiment",
    "diffraction",
    "polarization",
    "ray optics",
    "reflection",
    "refraction",
    "lenses",
    "mirrors",
    "optical instruments",
    "electrostatics",
    "coulomb's law",
    "electric field",
    "electric potential",
    "gauss law",
    "current electricity",
    "ohm's law",
    "resistance",
    "kirchhoff's laws",
    "wheatstone bridge",
    "potentiometer",
    "capacitors",
    "capacitance",
    "dielectrics",
    "energy stored in capacitor",
    "magnetic effects of current",
    "biot savart law",
    "ampere's law",
    "force on moving charge",
    "force on current carrying wire",
    "electromagnetic induction",
    "faraday's law",
    "lenz's law",
    "self inductance",
    "mutual inductance",
    "alternating current",
    "rms value",
    "phasor diagrams",
    "resonance in AC circuits",
    "electromagnetic waves",
    "spectrum of EM waves",
    "dual nature of matter",
    "photoelectric effect",
    "de broglie wavelength",
    "atoms",
    "bohr model",
    "spectral series",
    "nuclei",
    "radioactivity",
    "nuclear fission",
    "nuclear fusion",
    "semiconductors",
    "p-n junction",
    "diodes",
    "transistors",
    "logic gates",
    "basic concepts of chemistry",
    "mole concept",
    "atomic structure",
    "states of matter",
    "ideal gas laws",
    "real gases",
    "van der waals equation",
    "thermodynamics chemistry",
    "enthalpy",
    "entropy",
    "gibbs free energy",
    "equilibrium",
    "chemical equilibrium",
    "le chatelier principle",
    "ionic equilibrium",
    "pH",
    "buffer solutions",
    "solubility product",
    "redox reactions",
    "oxidation number",
    "balancing redox reactions",
    "chemical kinetics",
    "rate of reaction",
    "order and molecularity",
    "surface chemistry",
    "adsorption",
    "colloids",
    "catalysis",
    "electrochemistry",
    "electrochemical cells",
    "nernst equation",
    "corrosion",
    "solutions",
    "colligative properties",
    "vapor pressure lowering",
    "periodic table",
    "periodic trends",
    "ionization energy",
    "electronegativity",
    "chemical bonding",
    "VSEPR theory",
    "hybridization",
    "molecular orbital theory",
    "coordination compounds",
    "ligands",
    "coordination number",
    "isomerism",
    "p block elements",
    "s block elements",
    "d block elements",
    "f block elements",
    "hydrogen",
    "hydrides",
    "water",
    "hydrogen peroxide",
    "environmental chemistry",
    "pollutants",
    "green chemistry",
    "metallurgy",
    "ore concentration",
    "roasting",
    "smelting",
    "organic chemistry basics",
    "classification of organic compounds",
    "nomenclature",
    "isomerism",
    "structural isomerism",
    "stereoisomerism",
    "hydrocarbons",
    "alkanes",
    "alkenes",
    "alkynes",
    "aromatic hydrocarbons",
    "haloalkanes",
    "haloarenes",
    "alcohols",
    "phenols",
    "ethers",
    "aldehydes",
    "ketones",
    "carboxylic acids",
    "acid derivatives",
    "amines",
    "diazonium salts",
    "biomolecules",
    "carbohydrates",
    "proteins",
    "lipids",
    "nucleic acids",
    "polymers",
    "natural polymers",
    "synthetic polymers",
    "chemistry in everyday life",
    "drugs",
    "soaps",
    "detergents",
    "sets",
    "relations",
    "functions",
    "trigonometric ratios",
    "trigonometric identities",
    "matrices",
    "determinants",
    "complex numbers",
    "quadratic equations",
    "permutations and combinations",
    "binomial theorem",
    "sequences and series",
    "arithmetic progression",
    "geometric progression",
    "straight lines",
    "slope",
    "equation of line",
    "circles",
    "parabola",
    "ellipse",
    "hyperbola",
    "limits",
    "continuity",
    "differentiability",
    "derivatives",
    "applications of derivatives",
    "integrals",
    "indefinite integrals",
    "definite integrals",
    "differential equations",
    "probability",
    "bayes theorem",
    "statistics",
    "vector algebra",
    "dot product",
    "cross product",
    "3d geometry",
    "direction cosines",
    "direction ratios",
    "linear programming",
    "cell structure",
    "cell organelles",
    "cell membrane",
    "nucleus",
    "mitochondria",
    "cell division",
    "mitosis",
    "meiosis",
    "biomolecules",
    "proteins",
    "carbohydrates",
    "lipids",
    "enzymes",
    "plant physiology",
    "photosynthesis",
    "respiration in plants",
    "plant hormones",
    "human physiology",
    "digestive system",
    "respiratory system",
    "circulatory system",
    "excretory system",
    "nervous system",
    "endocrine system",
    "reproductive system",
    "male reproductive system",
    "female reproductive system",
    "reproduction in plants",
    "sexual reproduction in plants",
    "asexual reproduction in plants",
    "genetics",
    "mendel's laws",
    "dna replication",
    "rna transcription",
    "translation",
    "evolution",
    "darwin's theory",
    "lamarck's theory",
    "ecology",
    "ecosystem",
    "food chain",
    "food web",
    "environmental issues",
    "pollution",
    "climate change",
    "biotechnology",
    "genetic engineering",
    "cloning",
    "microbes in human welfare",
    "antibiotics",
    "fermentation",
    "light reflection refraction",
    "laws of reflection",
    "laws of refraction",
    "human eye and colourful world",
    "dispersion",
    "scattering of light",
    "electricity",
    "ohm's law",
    "resistance",
    "electric power",
    "magnetic effects of electric current",
    "electromagnetism",
    "electric motor",
    "electric generator",
    "sources of energy",
    "renewable energy",
    "non-renewable energy",
    "chemical reactions and equations",
    "types of chemical reactions",
    "acids bases and salts",
    "pH scale",
    "metals and non-metals",
    "corrosion",
    "alloys",
    "carbon compounds",
    "homologous series",
    "functional groups",
    "isomerism",
    "periodic classification of elements",
    "modern periodic table",
    "periodic trends",
    "life processes",
    "nutrition",
    "respiration",
    "transportation in plants",
    "transportation in animals",
    "control and coordination",
    "nervous system",
    "hormones in animals",
    "how do organisms reproduce",
    "heredity and evolution",
    "our environment",
    "ecosystem balance",
    "management of natural resources",
  ];

  const lowerQ = question.toLowerCase();
  const isAllowed = allowedTopics.some((topic) => lowerQ.includes(topic));

  if (!isAllowed) {
    return res.status(403).json({
      message:
        "Sorry, I can only answer questions related to JEE, NEET, or 10th CBSE.",
    });
  }

  try {
    // Add the API call to the queue. It will wait here until its turn.
    const answer = await queue.add(() => callChatGPT(question));
    res.json({ question, answer });
  } catch (error) {
    // This will catch errors from the queue or the API call itself
    console.error(
      "Error processing request:",
      error.response?.data || error.message
    );
    res
      .status(500)
      .json({ error: "Something went wrong while processing your request" });
  }
};
